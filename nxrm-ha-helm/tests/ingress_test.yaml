suite: test ingress
templates:
  - ingress.yaml
release:
  name: "test-release"
chart:
  version: "latest"
tests:
  - it: should create nexus ingress with no rules
    set:
      ingress:
        enabled: true
        host: null
        dockersubdomain: false
        defaultRule: false
        ingressClassName: nginx

    asserts:
      - isKind:
          of: Ingress

      - equal:
          path: metadata.name
          value: "nexus-ingress"

      - equal:
          path: spec.ingressClassName
          value:
            nginx
      - isNull:
          path: spec.rules

  - it: should create nexus ingress with default HTTP rule
    set:
      ingress:
        enabled: true
        host: null
        dockersubdomain: false
        defaultRule: true
        ingressClassName: nginx

    asserts:
      - isKind:
          of: Ingress

      - equal:
          path: metadata.name
          value: "nexus-ingress"

      - equal:
          path: spec.ingressClassName
          value:
            nginx
      - isNotNull:
          path: spec.rules

  - it: should create nexus ingress with default HTTP rule which has no host
    set:
      ingress:
        enabled: true
        host: null
        dockersubdomain: false
        defaultRule: true
        ingressClassName: nginx

    asserts:
      - isKind:
          of: Ingress

      - equal:
          path: metadata.name
          value: "nexus-ingress"

      - equal:
          path: spec.ingressClassName
          value:
            nginx
      - equal:
          path: spec.rules
          value:
            - http:
                paths:
                  - path: /
                    pathType: Prefix
                    backend:
                      service:
                        name: "nexus-service"
                        port:
                          number: 80

  - it: nexus ingress should have a HTTP rule with the host set
    set:
      ingress:
        enabled: true
        host: example.com
        dockersubdomain: false
        defaultRule: true
        ingressClassName: nginx

    asserts:
      - isKind:
          of: Ingress

      - equal:
          path: metadata.name
          value: "nexus-ingress"

      - equal:
          path: spec.ingressClassName
          value:
            nginx

      - equal:
          path: spec.rules
          value:
            - host: "example.com"
              http:
                paths:
                  - path: /
                    pathType: Prefix
                    backend:
                      service:
                        name: "nexus-service"
                        port:
                          number: 80

  - it: nexus ingress should have a default and docker subdomain routing rules
    set:
      ingress:
        enabled: true
        host: example.com
        dockersubdomain: true
        defaultRule: true
        ingressClassName: nginx

    asserts:
      - isKind:
          of: Ingress

      - equal:
          path: metadata.name
          value: "nexus-ingress"

      - equal:
          path: spec.ingressClassName
          value:
            nginx

      - equal:
          path: spec.rules
          value:
            - host: "example.com"
              http:
                paths:
                  - path: /
                    pathType: Prefix
                    backend:
                      service:
                        name: "nexus-service"
                        port:
                          number: 80
            - host: "*.example.com"
              http:
                paths:
                  - path: /
                    pathType: Prefix
                    backend:
                      service:
                        name: "nexus-service"
                        port:
                          number: 80

  - it: should create docker ingress without host
    set:
      ingress:
        dockerIngress:
          enabled: "true"
          ingressClassName: nginx

    asserts:
      - isKind:
          of: Ingress

      - equal:
          path: metadata.name
          value: "docker-ingress"

      - equal:
          path: spec.ingressClassName
          value:
            nginx

      - equal:
          path: spec.rules
          value:
            - http:
                paths:
                  - path: /
                    pathType: Prefix
                    backend:
                      service:
                        name: "nexus-docker-service"
                        port:
                          number: 9090

  - it: should create docker ingress with a HTTP rule with host set
    set:
      ingress:
        dockerIngress:
          enabled: "true"
          host: docker.example.com
          ingressClassName: nginx

    asserts:
      - isKind:
          of: Ingress

      - equal:
          path: metadata.name
          value: "docker-ingress"

      - equal:
          path: spec.ingressClassName
          value:
            nginx

      - equal:
          path: spec.rules
          value:
            - host: "docker.example.com"
              http:
                paths:
                  - path: /
                    pathType: Prefix
                    backend:
                      service:
                        name: "nexus-docker-service"
                        port:
                          number: 9090


  - it: should specify tls hosts
    set:
      ingress:
        enabled: true
        host: null
        dockersubdomain: false
        defaultRule: false
        ingressClassName: nginx
        tls:
          - secretName: "tlsSecretName1"
            hosts:
            - repo.foo1
            - repo.bar1
          - secretName: "tlsSecretName2"
            hosts:
              - repo.foo2
              - repo.bar2
    asserts:
      - isKind:
          of: Ingress

      - equal:
          path: metadata.name
          value: "nexus-ingress"

      - equal:
          path: spec.ingressClassName
          value:
            nginx

      - equal:
          path: spec.tls[0].hosts
          value:
            - repo.foo1
            - repo.bar1

      - equal:
          path: spec.tls[0].secretName
          value: tlsSecretName1


      - equal:
          path: spec.tls[1].hosts
          value:
            - repo.foo2
            - repo.bar2

      - equal:
          path: spec.tls[1].secretName
          value: tlsSecretName2